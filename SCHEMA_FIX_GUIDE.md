# スキーマ修正ガイド（即座に実行）

## 🎯 やること（3ステップ・10分で完了）

### ステップ 1: 現状確認（3分）

1. **Supabase Dashboard を開く**
   ```
   https://supabase.com/dashboard/project/swyiwqzlmozlqircyyzr/sql
   ```

2. **以下のファイルを開く**
   ```
   COMPLETE_SCHEMA_VERIFICATION.sql
   ```

3. **内容を全てコピーして SQL Editor にペースト → Run**

4. **結果を確認**
   - `MISSING:` で始まる行があれば、そのカラムが不足している
   - 不足カラムを確認したらステップ2へ

---

### ステップ 2: 一括修正（3分）

1. **以下のファイルを開く**
   ```
   COMPLETE_SCHEMA_FIX.sql
   ```

2. **内容を全てコピーして SQL Editor にペースト → Run**

3. **完了メッセージを確認**
   ```
   ✅ Schema fix completed successfully!
   ```

---

### ステップ 3: 修正確認（3分）

1. **もう一度ステップ1の検証SQLを実行**

2. **以下の結果になることを確認**
   ```
   ✅ All token refresh columns present
   ✅ All engagement columns present
   ✅ All loop columns present
   ```

3. **`MISSING:` が全て消えていればOK**

---

## 🧪 動作テスト（オプション）

修正後、以下をテストしてください：

### 1. トークンリフレッシュ
```
Supabase Dashboard → Edge Functions → refresh-tokens → Invoke
```
→ エラーなく完了すればOK

### 2. エンゲージメントルール
```
アプリ → /engagement → 新規ルール作成
```
→ 保存できればOK

### 3. ループ作成
```
アプリ → /loops → 新規ループ作成
```
→ 全てのループタイプ（Post/Reply/CTA）が作成できればOK

---

## ❓ トラブルシューティング

### Q1: SQLでエラーが出る
**A:** エラーメッセージをコピーして確認してください。ほとんどの場合、既に存在するものをスキップするだけなので問題ありません。

### Q2: まだ `MISSING:` が表示される
**A:**
1. ステップ2のSQLが完全に実行されたか確認
2. エラーメッセージがあるか確認
3. 再度ステップ2を実行（冪等性があるので安全）

### Q3: トークンリフレッシュがまだ動かない
**A:**
1. `account_tokens` テーブルに全てのカラムが存在するか確認
2. Edge Function のログでエラーを確認
3. 必要に応じて Edge Function を再デプロイ

---

## 📝 実行履歴記録（メモ用）

```
□ ステップ1実行: ___年___月___日 ___時___分
  → 不足カラム数: _______個

□ ステップ2実行: ___年___月___日 ___時___分
  → 実行結果: _______________

□ ステップ3実行: ___年___月___日 ___時___分
  → 全て ✅ : はい / いいえ

□ 動作テスト:
  □ トークンリフレッシュ: OK / NG
  □ エンゲージメント: OK / NG
  □ ループ: OK / NG
```

---

**完了したら、全ての機能が正常に動作するはずです！** 🎉
